<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delivery Fee Search</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    body{
      margin:0;
      background:#f6f7fb;
      color:#111;
      display:flex;
      justify-content:center;
      padding:40px 20px;
      box-sizing:border-box;
    }
    .card{
      margin-top:100px;
      width:100%;
      max-width:820px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(20,20,40,.08);
      padding:28px;
    }
    h1{margin:0 0 8px;font-size:20px}
    p.sub{margin:0 0 18px;color:#5b6170}

    .search-row{display:flex;gap:12px;flex-wrap:wrap}
    .search-input{flex:1;position:relative}
    input[type="search"], input[type="text"], input[type="number"]{width:100%;padding:12px 14px;border-radius:8px;border:1px solid #e1e3ea;font-size:15px}
    button{padding:10px 16px;border-radius:8px;border:0;background:#2563eb;color:#fff;font-weight:600;cursor:pointer}

    .suggestions{position:absolute;left:0;right:0;top:46px;background:#fff;border:1px solid #e1e3ea;border-radius:8px;max-height:260px;overflow:auto;box-shadow:0 8px 30px rgba(20,20,40,.06);z-index:20}
    .suggestion{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f2f3f7}
    .suggestion:last-child{border-bottom:0}
    .suggestion:hover,.suggestion.active{background:#f3f6ff}
    .meta{font-size:13px;color:#666;margin-top:4px}
    .highlight{font-weight:700;background:linear-gradient(90deg,#fff9c9,#ffd);}

    .results{margin-top:18px;padding:14px;border-radius:10px;background:#fbfdff;border:1px solid #eef2ff}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .col{flex:1;min-width:200px}
    .fee{font-weight:800;font-size:18px;color:#0b8a5f}

    .small{font-size:13px;color:#666}
    .hint{margin-top:12px;font-size:13px;color:#777;word-break:break-all}

    .form-section{margin-top:28px;padding:20px;border-radius:10px;background:#f9fafc;border:1px solid #e1e3ea}
    .form-section h2{margin:0 0 12px;font-size:18px}
    .form-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .form-row .form-input{flex:1}

    @media (max-width:520px){.search-row{flex-direction:column}.search-row button{width:100%}.form-row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="card">
    <h1>Delivery Fee Search</h1>
    <p class="sub">Search by store name and barangay. Suggestions appear as you type.</p>

    <div class="search-row">
      <div class="search-input">
        <input id="storeInput" type="search" placeholder="Search store name..." aria-label="Search store" autocomplete="off">
        <div id="storeSuggestions" class="suggestions" hidden></div>
      </div>
      <div class="search-input">
        <input id="barangayInput" type="search" placeholder="Search barangay..." aria-label="Search barangay" autocomplete="off">
        <div id="barangaySuggestions" class="suggestions" hidden></div>
      </div>
      <button id="searchBtn">Search</button>
    </div>

    <div id="results" class="results" hidden>
      <div id="resultList"></div>
    </div>

    <!-- New Delivery Fee Form -->
    <div class="form-section">
      <h2>Register New Delivery Fee</h2>
      <div class="form-row">
        <div class="form-input"><input id="newStore" type="text" placeholder="Store Name"></div>
        <div class="form-input"><input id="newBarangay" type="text" placeholder="Barangay"></div>
      </div>
      <div class="form-row">
        <div class="form-input"><input id="newArea" type="text" placeholder="Area/City"></div>
        <div class="form-input"><input id="newFee" type="number" placeholder="Delivery Fee"></div>
      </div>
      <button id="addBtn">Add Delivery Fee</button>
      <p class="small">Note: This form will call a Google Apps Script Web App to save permanently.</p>
    </div>
  </div>

<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR6uEc2dvXtQixLbwv5QXmSNozP5EvVETFh1TFzYHMJVnypWpafjOQj6JiVGav0b3RYs0TmUQrRkTJv/pub?gid=0&single=true&output=csv';

// Replace with your deployed Google Apps Script Web App URL
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6Lge0hirlVeWXWiKyKeQqCpUXZoAlEzlq2MdwsV9fvJSNMwqISRcMrdkcQ1lFMS6jxA/exec';

function parseCSV(text){
  const rows = [];
  let cur = '';
  let row = [];
  let inQuotes = false;
  for (let i = 0; i < text.length; i++){
    const ch = text[i];
    if (ch === '"'){
      if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (ch === ',' && !inQuotes){ row.push(cur); cur = ''; }
    else if ((ch === '\n' || ch === '\r') && !inQuotes){
      if (cur !== '' || row.length) { row.push(cur); cur = ''; rows.push(row); row = []; }
      if (ch === '\r' && text[i+1] === '\n') i++;
    } else { cur += ch }
  }
  if (cur !== '' || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

let data = [];

async function loadData(){
  try{
    const res = await fetch(CSV_URL);
    if (!res.ok) throw new Error('Network response was not ok');
    const text = await res.text();
    const rows = parseCSV(text).filter(r => r.length);
    if (!rows.length) throw new Error('No rows in CSV');
    const header = rows[0].map(h => h.trim());
    data = rows.slice(1).map(r => {
      const obj = {};
      for (let i=0;i<header.length;i++) obj[header[i]] = (r[i]||'').trim();
      return obj;
    }).filter(d => d[header[0]]);
  }catch(err){
    console.error(err);
    alert('Could not load CSV. See console for details.');
  }
}

function normalize(s){ return (s||'').toLowerCase(); }

function findMatches(storeQ, brgyQ){
  const sStore = normalize(storeQ);
  const sBrgy = normalize(brgyQ);
  const matches = [];
  for (const row of data){
    const store = normalize(row['Store Name'] || row['Store'] || row['StoreName']);
    const brgy = normalize(row['Brangay'] || row['Barangay'] || row['Brgy']);
    const area = row['Area/City'] || row['Area'] || row['City'] || '';
    const fee = row['Delivery'] || row['Delivery Fee'] || row['Fee'] || '';
    if ((sStore?store.includes(sStore):true) && (sBrgy?brgy.includes(sBrgy):true)){
      matches.push({store: row['Store Name'] || row['Store'] || '', area, brgy: row['Brangay'] || row['Barangay'] || '', fee});
    }
  }
  return matches;
}

function renderSuggestions(inputEl, suggestionsEl, list, q, type){
  suggestionsEl.innerHTML = '';
  if (!list.length){ suggestionsEl.hidden = true; return; }
  suggestionsEl.hidden = false;
  const unique = [...new Set(list.map(it => type==='store'?it.store:it.brgy))];
  unique.slice(0,10).forEach(val =>{
    const div = document.createElement('div');
    div.className = 'suggestion';
    div.innerHTML = highlight(val, q);
    div.addEventListener('click', ()=>{
      inputEl.value = val;
      suggestionsEl.hidden = true;
    });
    suggestionsEl.appendChild(div);
  });
}

function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function highlight(text, q){
  if (!q) return escapeHtml(text);
  const re = new RegExp('(' + escapeRegExp(q) + ')','ig');
  return escapeHtml(text).replace(re, '<span class="highlight">$1</span>');
}
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'); }

function showResults(list){
  const resultList = document.getElementById('resultList');
  const resultsEl = document.getElementById('results');
  resultList.innerHTML = '';
  if (!list || !list.length){ resultsEl.hidden = true; return; }
  resultsEl.hidden = false;
  list.forEach(it =>{
    const el = document.createElement('div');
    el.className = 'row';
    el.innerHTML = `
      <div class="col">
        <div style="font-weight:700">${escapeHtml(it.store)}</div>
        <div class="small">${escapeHtml(it.area)} Â· ${escapeHtml(it.brgy)}</div>
      </div>
      <div class="fee">${escapeHtml(it.fee)}</div>
    `;
    resultList.appendChild(el);
  });
}

function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), wait); }}

const storeInput = document.getElementById('storeInput');
const barangayInput = document.getElementById('barangayInput');

storeInput.addEventListener('input', debounce(function(e){
  const q = e.target.value.trim();
  const matches = findMatches(q, barangayInput.value.trim());
  renderSuggestions(storeInput, document.getElementById('storeSuggestions'), matches, q, 'store');
},120));

barangayInput.addEventListener('input', debounce(function(e){
  const q = e.target.value.trim();
  const matches = findMatches(storeInput.value.trim(), q);
  renderSuggestions(barangayInput, document.getElementById('barangaySuggestions'), matches, q, 'barangay');
},120));

document.getElementById('searchBtn').addEventListener('click', ()=>{
  const matches = findMatches(storeInput.value.trim(), barangayInput.value.trim());
  showResults(matches);
});

document.addEventListener('click', (e)=>{
  if (!e.target.closest('.search-input')){
    document.getElementById('storeSuggestions').hidden = true;
    document.getElementById('barangaySuggestions').hidden = true;
  }
});

// Permanent add via Google Apps Script
async function addDeliveryToSheet(store, brgy, area, fee){
  try{
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors', // Apps Script usually requires no-cors
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({store, brgy, area, fee})
    });
    alert('Delivery fee submitted to Google Sheet! It may take a few seconds to appear.');
  } catch (err) {
    console.error(err);
    alert('Error saving to Google Sheet.');
  }
}

document.getElementById('addBtn').addEventListener('click', ()=>{
  const store = document.getElementById('newStore').value.trim();
  const brgy = document.getElementById('newBarangay').value.trim();
  const area = document.getElementById('newArea').value.trim();
  const fee = document.getElementById('newFee').value.trim();
  if(store && brgy && area && fee){
    addDeliveryToSheet(store, brgy, area, fee);
    document.getElementById('newStore').value = '';
    document.getElementById('newBarangay').value = '';
    document.getElementById('newArea').value = '';
    document.getElementById('newFee').value = '';
  }else{
    alert('Please fill out all fields.');
  }
});

loadData();
</script>
</body>
</html>
